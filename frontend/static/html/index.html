<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fallstudie</title>
    <link rel="icon" href="./images/Herzbeben_Logo.png">
    <link rel="stylesheet" href="index.css">
    <script type=text/javascript src = "index.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset= utf-8" />

</head>

<body>
<!-- creates Slogan + Logo division -->
<div>
    <p id="slogan">A picture is worth a thousand words.
    </p>
</div>
<div id="background"></div>
<!-- creates Buttons that lead to Login/Account creating -->
<div id="choice">
    <button id="buttonCreate" onclick="showCreateAccount()">Create account</button>
    <button id="buttonLogin" onclick="showLogin()">Back to login</button>
</div>

<!--creates Help button log in-->
<div id = "help">
<button class="help">Help
    <span class="helpText">To sign in with your klicks-account please enter your username and password
        into the designated input box and click on the “Log In”-button afterwards. <br>
        If you don’t have a klicks-account, please select “Create Account” to register.
</span>
</button>
</div>

<!-- creates Help button register
<div id="helpRe">
    <button class="helpRe">Help
    <span class="helpText"> Please enter the required information and click on the "Create Account" button to register.
</span>
</button>
</div>-->

<!-- creates basic login-form -->
<div id="container">
    <form id="login" name="login">
        <p id="sign-in1">Sign in now!</p><br><br>
        <label for="usernamelogin">Username:</label>
        <input type="text" id="usernamelogin" name="usernamelogin" placeholder="Enter Username">
        <label for="passwordlogin">Password:</label>
        <input type="password" id="passwordlogin" name="passwordlogin" placeholder="Enter Password">
        <div id="lower">
            <input type="checkbox"><label for="checkbox">Keep me logged in</label>
            <input type="submit" value="Login" onclick="signinUser()">
        </div>
    </form>
</div>
<script>
window.onload = function () {
    if (document.cookie) {
        window.location.replace("http://localhost:8080/compare.html");
    }
    else {
        var text = "Username: maxm   Password: 1234";
        alert(text);
    }
};




function checkNotEmpty(usernamel,passwordl) {
    if (usernamel === "" || usernamel === null) {
        alert('Please type in a Username!');
    }
    else if (passwordl === "" || passwordl === null) {
        alert('Please type in a Password!');

    }
    else if (document.cookie) {
        window.location.replace("http://localhost:8080/compare.html");
    }
    else {
        var xmlhttplog = new XMLHttpRequest(); // new HttpRequest instance
        xmlhttplog.open("GET", "http://localhost:8080/meetme/api/person/username/" + usernamel, true);
        xmlhttplog.setRequestHeader("Content-Type", "application/json");
        //sent the new HttpRequest
        xmlhttplog.send(null);
        alert('request für user gesendet');
        xmlhttplog.onreadystatechange = function () {
            if (xmlhttplog.readyState == XMLHttpRequest.DONE) {
                var json = xmlhttplog.responseText;
                var userdata = JSON.parse(json);
                //alert (userdata);
                var dbpassword = (userdata.password);
                var dbusername = (userdata.username);
                alert('db passwort = ' + dbpassword + '  db username = ' + dbusername);
                if (dbpassword === passwordl && dbusername === usernamel) {
                    document.cookie = "id=" + userdata.id;
                    window.location.replace("http://localhost:8080/compare.html");
                }
                else {
                    alert ('wrong username or password!');
                }
            }
        }
    }
}
    function signinUser(){
        //alert('signin started'); //debug purpose only

        //initalizing variables with textfields from html signin form

        var usernamel = document.getElementById("usernamelogin").value;
        var passwordl = document.getElementById("passwordlogin").value;
        //alert('username = ' + usernamel + 'passwort = ' + passwordl);
         //creates alert if no username or password is typed in

        checkNotEmpty(usernamel,passwordl);
    }

</script>



<!-- creates signup sheet -->
<div id="signup">
    <form name="signupform" id="signupform" >
        <label for="mail">E-Mail address:</label>
        <input type="text" id="mail" name="mail" placeholder="Enter Email-Adress">
        <label for="firstname">Firstname:</label>
        <input type="text" id="firstname" name="firstname" placeholder="Enter Firstname">
        <label for="lastname">Lastname:</label>
        <input type="text" id="lastname" name="lastname" placeholder="Enter Lastname">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" placeholder="Enter Username">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" placeholder="Enter Password">
        <label for="confpassword">Confirm password:</label>
        <input type="password" id="confpassword" name="confpassword" placeholder="Confirm Password">
        <div id="lower2">
            <input type="checkbox" id = "AGBcheckbox"><label for="AGBcheckbox" >I have read the <a onclick="openAGB()" href="">AGB's</a></label>
            <input type="submit" value="Create account" onclick="registerUser()" >

            <button class="helpRe">Help
                <span class="helpText"> Please enter the required information and click on the "Create Account" button to register.
                </span>
            </button>

        </div>
    </form>
</div>

<!-- Opens the AGB window -->
<div id="AGBModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="modal-header">
            <h2>AGB</h2>
        </div>
        <div class="modal-body">
            <form>
                <p>TERMS OF USE
                    Last revised on 10/17/2018
                    1. Acceptance of Terms of Use Agreement.

                    By creating a klicks account, you agree to be bound by these Terms of Use, which is incorporated by reference into this Agreement, and (iii) any terms disclosed and agreed to by you if you purchase additional features, products or services we offer on the Service (collectively, this “Agreement”). If you do not accept and agree to be bound by all of the terms of this Agreement, please do not use the Service.
                    We may make changes to this Agreement and to the Service from time to time. We may do this for a variety of reasons including to reflect changes in or requirements of the law, new features, or changes in business practices. The most recent version of this Agreement will be posted on the Service under Settings and also on klicks.com, and you should regularly check for the most recent version. The most recent version is the version that applies. If the changes include material changes that affect your rights or obligations, we will notify you in advance of the changes by reasonable means, which could include notification through the Service or via email. If you continue to use the Service after the changes become effective, then you agree to the revised Agreement.
                    2. Eligibility.
                    You must be at least 18 years of age to create an account on klicks and use the Service. By creating an account and using the Service, you represent and warrant that:
                    •	you can form a binding contract with klicks,
                    •	you are not a person who is barred from using the Service under the laws of the United States or any other applicable jurisdiction–meaning that you do not appear on the U.S. Treasury Department’s list of Specially Designated Nationals or face any other similar prohibition,
                    •	you will comply with this Agreement and all applicable local, state, national and international laws, rules and regulations, and
                    •	you have never been convicted of a felony or indictable offense (or crime of similar severity), a sex crime, or any crime involving violence, and that you are not required to register as a sex offender with any state, federal or local sex offender registry.

                </p>
            </form>
        </div>
    </div>
</div>
<script>

    //AGB Modal
    var modal = document.getElementById('AGBModal');

    // Get the button that opens the modal
    var btn = document.getElementById("AGBcheckbox");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function openAGB() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

        function registerUser() {
            alert('register started'); //debug purpose only

            // initalizing variables with textfields from html signup form
            var email = document.getElementById("mail").value;
            var lastname = document.getElementById("lastname").value;
            var firstname = document.getElementById("firstname").value;
            var username = document.getElementById("username").value;
            var password = document.getElementById("password").value;
            var confpw = document.getElementById("confpassword").value;

            function createuser() {


                // Check if ConfirmationPW = PW
                if (checkPassword(confpw, password) === true) {
                    //create hashed PW
                    //var valpw = createvalidpw(password);

                    var xmlhttp = new XMLHttpRequest(); // new HttpRequest instance

                    xmlhttp.open("POST", "http://localhost:8080/meetme/api/person");
                    xmlhttp.setRequestHeader("Content-Type", "application/json");
                    //sent the new HttpRequest
                    xmlhttp.send(JSON.stringify({
                        "email": email,
                        "password": password,
                        "name": lastname,
                        "firstName": firstname,
                        "username": username
                    }));

                }
                else {
                    alert('signin failed');
                }
            }


            function checkdataindb(email, username) {
                var xhr = new XMLHttpRequest();
                var json;
                var anzahluser;

                function createcookie() {
                    var xmlhttpcookie = new XMLHttpRequest(); // new HttpRequest instance

                    xmlhttpcookie.open("GET", "http://localhost:8080/meetme/api/person/username/" + username, true);
                    xmlhttpcookie.setRequestHeader("Content-Type", "application/json");
                    //sent the new HttpRequest
                    xmlhttpcookie.send(null);
                    xmlhttpcookie.onreadystatechange = function () {
                        if (xmlhttpcookie.readyState == XMLHttpRequest.DONE) {
                            var json = xmlhttpcookie.responseText;
                            var userdata = JSON.parse(json);
                            document.cookie = "id=" + userdata.id;
                        }
                    }

                }

                xhr.open('GET', 'http://localhost:8080/meetme/api/person', true);
                xhr.send(null);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        json = xhr.responseText;

                        var userlist = JSON.parse(json);
                        anzahluser = (Object.keys(userlist).length)

                        var useravailable = true;
                        for (var i = 0; i < anzahluser; i++) {
                            if (userlist[i].email === email) {
                                alert('Their is already an account with this Email: ' + email);
                                window.location.replace("http://localhost:8080/index.html");
                                return useravailable = false;
                            }
                            else if (userlist[i].username === username) {
                                alert('Username ' + username + ' is already taken!');
                                window.location.replace("http://localhost:8080/index.html");
                                return useravailable = false;
                            }
                        }
                        if (useravailable === true) {
                            createuser();
                            createcookie();

                            window.location.replace("http://localhost:8080/compare.html");
                        }
                    }
                }

            }

            checkdataindb(email, username);


    }

</script>


</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fallstudie</title>
    <link rel="icon" href="./images/Herzbeben_Logo.png">
    <link rel="stylesheet" href="index.css">
    <script type=text/javascript src = "index.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset= utf-8" />

</head>

<body>
<!-- creates Slogan + Logo division -->
<div>
    <p id="slogan">A picture is worth a thousand words.
    </p>
</div>
<div id="background"></div>
<!-- creates Buttons that lead to Login/Account creating -->
<div id="choice">
    <button id="buttonCreate" onclick="showCreateAccount()">Create account</button>
    <button id="buttonLogin" onclick="showLogin()">Back to login</button>
</div>

<!--creates Help button log in-->
<div id = "help">
<button class="help">Help
    <span class="helpText">To sign in with your klicks-account please enter your username and password
        into the predicted input box and click on the “Log In”-button afterwards. <br>
        If you don’t have a klicks-account, please select “Create Account” to register.
</span>
</button>
</div>

<!-- creates Help button register-->
<div id="helpRe">
    <button class="helpRe">Help
    <span class="helpText"> Please enter the required information and click on the "Create Account" button to register.
</span>
</button>
</div>

<!-- creates basic login-form -->
<div id="container">
    <form id="login" name="login">
        <p id="sign-in1">Sign in now!</p><br><br>
        <label for="usernamelogin">Username:</label>
        <input type="text" id="usernamelogin" name="usernamelogin" placeholder="Enter Username">
        <label for="passwordlogin">Password:</label>
        <input type="password" id="passwordlogin" name="passwordlogin" placeholder="Enter Password">
        <div id="lower">
            <input type="checkbox"><label for="checkbox">Keep me logged in</label>
            <input type="submit" value="Login" onclick="signinUser()">
        </div>
    </form>
</div>
<script>
/*window.onload = function () {
   function cookiesEnabled () {
        var cookieEnabled = (navigator.cookieEnabled) ? true : false;

        if (typeof navigator.cookieEnabled == "undefined" && !cookieEnabled) {
            document.cookie="testcookie";
            cookieEnabled = (document.cookie.indexOf("testcookie") != -1) ? true : false;
        }
        return (cookieEnabled);
    }
    cookiesEnabled();



    if ( document.cookie) {
        window.location.replace("http://localhost:8080/compare.html");
    }
};*/
function checkNotEmpty(usernamel,passwordl) {
    if (usernamel === "" || usernamel === null) {
        alert('Please type in a Username!');
    }
    else if (passwordl === "" || passwordl === null) {
        alert('Please type in a Password!');

    }
    else if (document.cookie) {
        window.location.replace("http://localhost:8080/compare.html");
    }
    else {
        alert('in der signin else');
        alert(usernamel + ' ' + passwordl);
        // Check if ConfirmationPW = PW

        //create hashed PW
        //var valpw = createvalidpw(password);
        //alert(valpw); //debug purpose only

        var xmlhttplog = new XMLHttpRequest(); // new HttpRequest instance

        xmlhttplog.open("GET", "http://localhost:8080/meetme/api/person/username/" + usernamel, true);
        xmlhttplog.setRequestHeader("Content-Type", "application/json");
        //sent the new HttpRequest
        xmlhttplog.send(null);
        alert('request für user gesendet');
        xmlhttplog.onreadystatechange = function () {
            if (xmlhttplog.readyState == XMLHttpRequest.DONE) {
                var json = xmlhttplog.responseText;
                var userdata = JSON.parse(json);
                alert (userdata);
                var dbpassword = (userdata.password);
                var dbusername = (userdata.username);
                alert('db passwort = ' + dbpassword + '  db username = ' + dbusername);
                if (dbpassword === passwordl && dbusername === usernamel) {
                    document.cookie = "id=" + userdata.id;
                    window.location.replace("http://localhost:8080/compare.html");
                }
            }
        }
    }
}
    function signinUser(){
        alert('signin started'); //debug purpose only

        //initalizing variables with textfields from html signin form

        var usernamel = document.getElementById("usernamelogin").value;
        var passwordl = document.getElementById("passwordlogin").value;
        alert('username = ' + usernamel + 'passwort = ' + passwordl);
         //creates alert if no username or password is typed in

        checkNotEmpty(usernamel,passwordl);
    }

</script>



<!-- creates signup sheet -->
<div id="signup">
    <form name="signupform" id="signupform" >
        <label for="mail">E-Mail address:</label>
        <input type="text" id="mail" name="mail" placeholder="Enter Email-Adress">
        <label for="firstname">Firstname:</label>
        <input type="text" id="firstname" name="firstname" placeholder="Enter Firstname">
        <label for="lastname">Lastname:</label>
        <input type="text" id="lastname" name="lastname" placeholder="Enter Lastname">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" placeholder="Enter Username">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" placeholder="Enter Password">
        <label for="confpassword">Confirm password:</label>
        <input type="password" id="confpassword" name="confpassword" placeholder="Confirm Password">
        <div id="lower2">
            <input type="submit" value="Create account" onclick="registerUser()" >
        </div>
    </form>
</div>

<script>


   function registerUser(){
       alert('shit started'); //debug purpose only

       // initalizing variables with textfields from html signup form
       var email = document.getElementById("mail").value;
       var lastname = document.getElementById("lastname").value;
       var firstname = document.getElementById("firstname").value;
       var username = document.getElementById("username").value;
       var password = document.getElementById("password").value;
       var confpw = document.getElementById("confpassword").value;

       function createuser() {


           // Check if ConfirmationPW = PW
           if (checkPassword(confpw, password) === true) {
               //create hashed PW
               //var valpw = createvalidpw(password);

               var xmlhttp = new XMLHttpRequest(); // new HttpRequest instance

               xmlhttp.open("POST", "http://localhost:8080/meetme/api/person");
               xmlhttp.setRequestHeader("Content-Type", "application/json");
               //sent the new HttpRequest
               xmlhttp.send(JSON.stringify({
                   "email": email,
                   "password": password,
                   "name": lastname,
                   "firstName": firstname,
                   "username": username
               }));

                    }
           else
               {
                   alert('signin failed');
               }
           }



           function checkdataindb(email, username) {
               var xhr = new XMLHttpRequest();
               var json;
               var anzahluser;

               function createcookie (){
                   var xmlhttpcookie = new XMLHttpRequest(); // new HttpRequest instance

                   xmlhttpcookie.open("GET", "http://localhost:8080/meetme/api/person/username/" + username, true);
                   xmlhttpcookie.setRequestHeader("Content-Type", "application/json");
                   //sent the new HttpRequest
                   xmlhttpcookie.send(null);
                   xmlhttpcookie.onreadystatechange = function () {
                       if (xmlhttpcookie.readyState == XMLHttpRequest.DONE) {
                           var json = xmlhttpcookie.responseText;
                           var userdata = JSON.parse(json);
                           document.cookie = "id=" + userdata.id;
                       }
                   }

               }
               xhr.open('GET', 'http://localhost:8080/meetme/api/person', true);
               xhr.send(null);

               xhr.onreadystatechange = function () {
                   if (xhr.readyState == XMLHttpRequest.DONE) {
                       json = xhr.responseText;

                       var userlist = JSON.parse(json);
                       anzahluser = (Object.keys(userlist).length)

                       var useravailable = true;
                       for (var i = 0; i < anzahluser; i++) {
                           if (userlist[i].email === email) {
                               alert('Their is already an account with this Email: ' + email);
                               window.location.replace("http://localhost:8080/index.html");
                               return useravailable = false;
                           }
                           else if (userlist[i].username === username) {
                               alert('Username ' + username + ' is already taken!');
                               window.location.replace("http://localhost:8080/index.html");
                               return useravailable = false;
                           }
                       }
                       if (useravailable === true) {
                           createuser();
                           createcookie();

                           window.location.replace("http://localhost:8080/compare.html");
                       }
                   }
               }

           }

       checkdataindb(email, username);
   }



</script>


</body>
</html>